blueprint:
  name: "üèõÔ∏è Sveglia dell'Architetto ‚Äì Assistente Domiciliare v2.0"
  description: >
    Risveglio multi-zona intelligente guidato da gesto umano.
    Una sola esecuzione al giorno con timeout, affidabile anche dopo riavvii.
    Include gestione errori e log completi.
  domain: automation
  input:
    ultima_routine:
      name: "üß† Ultima esecuzione routine"
      description: "Input datetime per tracciare l'ultima esecuzione"
      selector:
        entity:
          domain: input_datetime

    # Orari settimanali
    ora_lunedi:
      name: "üóìÔ∏è Luned√¨"
      selector: { time: {} }
    ora_martedi:
      name: "üóìÔ∏è Marted√¨"
      selector: { time: {} }
    ora_mercoledi:
      name: "üóìÔ∏è Mercoled√¨"
      selector: { time: {} }
    ora_giovedi:
      name: "üóìÔ∏è Gioved√¨"
      selector: { time: {} }
    ora_venerdi:
      name: "üóìÔ∏è Venerd√¨"
      selector: { time: {} }
    ora_sabato:
      name: "üóìÔ∏è Sabato"
      selector: { time: {} }
    ora_domenica:
      name: "üóìÔ∏è Domenica"
      selector: { time: {} }

    # Dispositivi coperture
    serrande_camere:
      name: "ü™ü Serrande camere"
      selector:
        entity:
          domain: cover
          multiple: true
    posizione_serrande_camere:
      name: "üìä Apertura serrande camere (%)"
      description: "Percentuale di apertura iniziale serrande camere"
      default: 15
      selector:
        number:
          min: 0
          max: 100
          step: 5
          unit_of_measurement: "%"
    serranda_bagno:
      name: "üöø Serranda bagno"
      selector:
        entity:
          domain: cover
    tapparelle_piano_terra:
      name: "üè† Tapparelle piano terra"
      selector:
        entity:
          domain: cover
          multiple: true

    # Sensori e luci
    sensore_movimento:
      name: "üö∂ Sensore movimento"
      selector:
        entity:
          domain: binary_sensor
    timeout_movimento:
      name: "‚è±Ô∏è Timeout attesa movimento (minuti)"
      description: "Tempo massimo di attesa movimento prima di annullare la routine"
      default: 30
      selector:
        number:
          min: 15
          max: 120
          step: 5
          unit_of_measurement: "min"
    luci_da_attivare:
      name: "üí° Luci da attivare"
      selector:
        entity:
          domain: light
          multiple: true

    # Ritardi temporali
    ritardo_tapparelle:
      name: "‚è≤Ô∏è Ritardo apertura tapparelle PT (secondi)"
      description: "Ritardo dopo movimento per aprire tapparelle piano terra"
      default: 10
      selector:
        number:
          min: 0
          max: 60
          step: 5
          unit_of_measurement: "s"
    ritardo_caffe:
      name: "‚òï Ritardo attivazione caff√® (minuti)"
      description: "Ritardo dopo apertura tapparelle per avviare caff√®"
      default: 10
      selector:
        number:
          min: 5
          max: 30
          step: 1
          unit_of_measurement: "min"

    # Dispositivi smart
    macchina_caffe:
      name: "‚òï Macchina del caff√®"
      selector:
        entity:
          domain: switch
    persona:
      name: "üë§ Persona"
      description: "Entit√† person per verifica presenza"
      selector:
        entity:
          domain: person
    porta_ingresso:
      name: "üö™ Porta ingresso"
      selector:
        entity:
          domain: lock

trigger:
  - platform: time
    at: !input ora_lunedi
    id: lunedi
  - platform: time
    at: !input ora_martedi
    id: martedi
  - platform: time
    at: !input ora_mercoledi
    id: mercoledi
  - platform: time
    at: !input ora_giovedi
    id: giovedi
  - platform: time
    at: !input ora_venerdi
    id: venerdi
  - platform: time
    at: !input ora_sabato
    id: sabato
  - platform: time
    at: !input ora_domenica
    id: domenica

condition:
  - condition: template
    value_template: >
      {# leggo lo stato dell'input datetime (instanziato dall'utente) #}
      {% set ultima = states(!input ultima_routine) %}

      {# Verifica che sia il giorno corretto #}
      {% set oggi_corretto = (
        (trigger.id == 'lunedi' and now().weekday() == 0) or
        (trigger.id == 'martedi' and now().weekday() == 1) or
        (trigger.id == 'mercoledi' and now().weekday() == 2) or
        (trigger.id == 'giovedi' and now().weekday() == 3) or
        (trigger.id == 'venerdi' and now().weekday() == 4) or
        (trigger.id == 'sabato' and now().weekday() == 5) or
        (trigger.id == 'domenica' and now().weekday() == 6)
      ) %}

      {# Se non √® il giorno corretto, non eseguire #}
      {% if not oggi_corretto %}
        false
      {# Se non c'√® traccia dell'ultima esecuzione, esegui #}
      {% elif ultima in ['unknown', 'unavailable', '', none] %}
        true
      {# Altrimenti verifica che non sia gi√† stata eseguita oggi (as_datetime pi√π robusto) #}
      {% else %}
        {% set ultima_dt = as_datetime(ultima) %}
        {{ ultima_dt is none or ultima_dt.date() != now().date() }}
      {% endif %}

action:
  # ===== FASE 1: INIZIALIZZAZIONE =====
  - action: logbook.log
    data:
      name: "Sveglia Architetto"
      message: "üåÖ Routine {{ trigger.id | title }} avviata alle {{ now().strftime('%H:%M') }}"

  - action: input_datetime.set_datetime
    target:
      entity_id: !input ultima_routine
    data:
      datetime: "{{ now() }}"
    continue_on_error: true

  # ===== FASE 2: APERTURA SERRANDE CAMERE =====
  - action: cover.set_cover_position
    target:
      entity_id: !input serrande_camere
    data:
      position: !input posizione_serrande_camere
    continue_on_error: true

  - action: logbook.log
    data:
      name: "Sveglia Architetto"
      message: "ü™ü Serrande camere inviate al valore configurato"

  # ===== FASE 3: APERTURA BAGNO =====
  - action: cover.open_cover
    target:
      entity_id: !input serranda_bagno
    continue_on_error: true

  - action: logbook.log
    data:
      name: "Sveglia Architetto"
      message: "üöø Serranda bagno aperta completamente"

  # ===== FASE 4: ATTESA MOVIMENTO CON TIMEOUT =====
  - action: logbook.log
    data:
      name: "Sveglia Architetto"
      message: "üëÄ In attesa di movimento (timeout: {{ !input timeout_movimento }} min)..."

  - wait_for_trigger:
      - platform: state
        entity_id: !input sensore_movimento
        to: "on"
    timeout:
      minutes: !input timeout_movimento
    continue_on_timeout: false

  # Verifica se c'√® stato movimento o timeout
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ wait is not none }}"
        sequence:
          - action: logbook.log
            data:
              name: "Sveglia Architetto"
              message: "‚úÖ Movimento rilevato alle {{ now().strftime('%H:%M') }}, proseguo con la routine"
    default:
      - action: logbook.log
        data:
          name: "Sveglia Architetto"
          message: "‚è±Ô∏è Timeout raggiunto ({{ !input timeout_movimento }} min), routine annullata"
      - stop

  # ===== FASE 5: ACCENSIONE LUCI =====
  - action: light.turn_on
    target:
      entity_id: !input luci_da_attivare
    continue_on_error: true

  - action: logbook.log
    data:
      name: "Sveglia Architetto"
      message: "üí° Luci accese"

  # ===== FASE 6: APERTURA TAPPARELLE PIANO TERRA =====
  - delay:
      seconds: !input ritardo_tapparelle

  - action: logbook.log
    data:
      name: "Sveglia Architetto"
      message: "üè† Invio comando apertura tapparelle piano terra..."

  - action: cover.set_cover_position
    target:
      entity_id: !input tapparelle_piano_terra
    data:
      position: 100
    continue_on_error: true

  - action: logbook.log
    data:
      name: "Sveglia Architetto"
      message: "‚úÖ Comando inviato alle tapparelle piano terra (100%)"

  # ===== FASE 7: CAFF√à E PORTA =====
  - delay:
      minutes: !input ritardo_caffe

  # Attiva caff√® sempre
  - action: switch.turn_on
    target:
      entity_id: !input macchina_caffe
    continue_on_error: true

  - action: logbook.log
    data:
      name: "Sveglia Architetto"
      message: "‚òï Macchina del caff√® attivata"

  # Sblocca porta solo se persona in casa
  - choose:
      - conditions:
          - condition: state
            entity_id: !input persona
            state: "home"
        sequence:
          - action: lock.unlock
            target:
              entity_id: !input porta_ingresso
            continue_on_error: true
          - action: logbook.log
            data:
              name: "Sveglia Architetto"
              message: "üö™ Porta sbloccata (persona in casa)"
    default:
      - action: logbook.log
        data:
          name: "Sveglia Architetto"
          message: "üö™ Porta non sbloccata (persona non in casa)"

  # ===== FASE 8: COMPLETAMENTO =====
  - action: logbook.log
    data:
      name: "Sveglia Architetto"
      message: "‚ú® Routine completata con successo"

mode: single
max_exceeded: silent
